import Queue from"./queue.js";let QUEUE;import{TEAMSERVER_INDEX_PATH_SUFFIX,TEAMSERVER_ACCOUNT_PATH_SUFFIX,VALID_TEAMSERVER_HOSTNAMES,TEAMSERVER_PROFILE_PATH_SUFFIX,CONTRAST_RED,TRACES_REQUEST,GATHER_FORMS_ACTION,LOADING_DONE,APPLICATION_CONNECTED,APPLICATION_DISCONNECTED,getStoredCredentials,isCredentialed,isBlacklisted,updateTabBadge,removeLoadingBadge,loadingBadge,updateExtensionIcon}from"./util.js";import Application from"./models/Application.js";import Vulnerability from"./models/Vulnerability.js";import VulnerableTab from"./models/VulnerableTab.js";import DomainStorage from"./models/DomainStorage.js";let TAB_CLOSED=!1;function resetXHRRequests(){window.XHR_REQUESTS=[]}window.XHR_REQUESTS=[],window.PAGE_FINISHED_LOADING=!1;const XHRDomains=new DomainStorage;function _handleWebRequest(e){const{method:t,url:n}=e,a=n.split("?")[0],o=["OPTIONS"!==t,!isBlacklisted(n),!window.XHR_REQUESTS.includes(a)];window.PAGE_FINISHED_LOADING&&QUEUE.executionCount>0&&o.every(Boolean)&&(window.XHR_REQUESTS.push(a),Vulnerability.evaluateSingleURL(a,QUEUE.tab,QUEUE.application)),o.every(Boolean)&&window.XHR_REQUESTS.push(a)}async function _handleRuntimeOnMessage(e,t,n){if(e)switch(e.action){case TRACES_REQUEST:{const a=VulnerableTab.buildTabPath(n.url),o=new VulnerableTab(a,e.application.name);t({traces:(await o.getStoredTab())[o.vulnTabId]}),removeLoadingBadge(n);break}case APPLICATION_CONNECTED:XHRDomains.addDomainsToStorage(e.data.domains);break;case APPLICATION_DISCONNECTED:XHRDomains.removeDomainsFromStorage(e.data.domains);break;case LOADING_DONE:window.PAGE_FINISHED_LOADING=!0;break;default:return e}return e}async function _queueActions(e,t){QUEUE.setTab(e);const n=[getStoredCredentials(),Application.retrieveApplicationFromStorage(e)],a=await Promise.all(n);a||(updateTabBadge(e,"!",CONTRAST_RED),updateExtensionIcon(e,1)),a[0]?a[1]||updateExtensionIcon(e,1):updateExtensionIcon(e,2),QUEUE.setCredentialed(isCredentialed(a[0])),QUEUE.setApplication(a[1]);let o=[];t&&(o=await _gatherFormsFromPage(e)),QUEUE.addForms(o,!0),QUEUE.addXHRequests(window.XHR_REQUESTS,!0),QUEUE.executeQueue(resetXHRRequests)}function _tabIsReady(e,t){return(!e.favIconUrl||1!==Object.keys(e).length)&&(!(!t.active||!e.status)&&(!chrome.runtime.lastError&&(!(!t.url.includes("http://")&&!t.url.includes("https://"))&&("loading"!==e.status||(resetXHRRequests(),TAB_CLOSED||(loadingBadge(t),TAB_CLOSED=!1),!1)))))}function _gatherFormsFromPage(e){return new Promise(t=>isBlacklisted(e.url)?t([]):chrome.tabs.sendMessage(e.id,{action:GATHER_FORMS_ACTION},e=>e&&e.formActions&&Array.isArray(e.formActions)?t(e.formActions):t([])))}function notifyUserToConfigure(e){if(chrome.runtime.lastError)return;const t=new URL(e.url),n=[VALID_TEAMSERVER_HOSTNAMES.includes(t.hostname)&&e.url.endsWith(TEAMSERVER_ACCOUNT_PATH_SUFFIX),e.url.endsWith(TEAMSERVER_PROFILE_PATH_SUFFIX)&&-1!==e.url.indexOf(TEAMSERVER_INDEX_PATH_SUFFIX),!chrome.runtime.lastError];!TAB_CLOSED&&n.some(e=>!!e)&&(updateExtensionIcon(e,2),TAB_CLOSED=!1)}chrome.webRequest.onBeforeRequest.addListener(e=>{_handleWebRequest(e)},{urls:XHRDomains.domains,types:["xmlhttprequest"]}),chrome.runtime.onMessage.addListener((e,t,n)=>{const{tab:a}=e;return a&&a.active?(e.action!==TRACES_REQUEST&&e.action!==LOADING_DONE&&(TAB_CLOSED||(loadingBadge(a),TAB_CLOSED=!1)),a&&!isBlacklisted(a.url)?_handleRuntimeOnMessage(e,n,a):e.action===APPLICATION_DISCONNECTED?_handleRuntimeOnMessage(e,n,a):(removeLoadingBadge(a),n(null)),!0):(n("Tab not active"),!1)}),chrome.tabs.onActivated.addListener(e=>{window.PAGE_FINISHED_LOADING=!0,QUEUE=new Queue,chrome.tabs.get(e.tabId,e=>{e&&!chrome.runtime.lastError&&_queueActions(e,!1)})}),chrome.tabs.onUpdated.addListener((e,t,n)=>{QUEUE&&QUEUE.resetExecutionCount(),_tabIsReady(t,n)&&(QUEUE=new Queue,_queueActions(n,!0))}),chrome.tabs.onRemoved.addListener(()=>{TAB_CLOSED=!0});export{TAB_CLOSED,_handleRuntimeOnMessage,notifyUserToConfigure,resetXHRRequests};