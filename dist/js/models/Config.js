import{STORED_APPS_KEY,STORED_TRACES_KEY,VALID_TEAMSERVER_HOSTNAMES,TEAMSERVER_ACCOUNT_PATH_SUFFIX,TEAMSERVER_PROFILE_PATH_SUFFIX,TEAMSERVER_INDEX_PATH_SUFFIX,CONTRAST_INITIALIZE,CONTRAST_INITIALIZED,setElementText,setElementDisplay,changeElementVisibility,hideElementAfterTimeout,CONTRAST_ORG_UUID,TEAMSERVER_URL,CONTRAST_SERVICE_KEY,CONTRAST_API_KEY,CONTRAST_USERNAME,UUID_V4_REGEX}from"../util.js";import{indexFunction}from"../index.js";import ContrastCredentials from"./ContrastCredentials.js";export default function Config(e,t,n,i,o){this.tab=e,this.url=t,this.credentialed=n,this.credentials=i,this.hasApp=o,this._handleConfigButtonClick=this._handleConfigButtonClick.bind(this),this._handleAppsClick=this._handleAppsClick.bind(this),this._handleGearClick=this._handleGearClick.bind(this),this._addListenerToUsername=this._addListenerToUsername.bind(this),this._handleBackButtonClick=this._handleBackButtonClick.bind(this)}const CREDENTIALED_CONFIG_SCREEN=0,CONFIG_SCREEN=1,VULNS_SCREEN=2,APPS_SCREEN=3;let SCREEN_STATE,POPUP_STATE=new Set;const POPUP_SCREENS={0:[document.getElementById("configuration-section"),document.getElementById("vulnerabilities-header"),document.getElementById("configured-footer")],1:[document.getElementById("configuration-section"),document.getElementById("configuration-header"),document.getElementById("configuration-footer")],2:[document.getElementById("vulnerabilities-section"),document.getElementById("vulnerabilities-header"),document.getElementById("configured-footer")],3:[document.getElementById("application-table-container-section"),document.getElementById("vulnerabilities-header"),document.getElementById("configured-footer")]};function loadingIconHTML(){return'<img style="float: right; padding-bottom: 20px; width: 50px;" id="config-loading-icon" class="loading-icon" src="/img/ring-alt.gif" alt="loading">'}Config.prototype.popupScreen=function(e=null){"number"!=typeof e&&(e=this.getPopupScreen());for(let t in POPUP_SCREENS)Object.prototype.hasOwnProperty.call(POPUP_SCREENS,t)&&parseInt(t,10)!==e&&POPUP_SCREENS[t].forEach(e=>{e&&setElementDisplay(e,"none")});for(let t in POPUP_SCREENS)Object.prototype.hasOwnProperty.call(POPUP_SCREENS,t)&&parseInt(t,10)===e&&POPUP_SCREENS[t].forEach(e=>{e&&setElementDisplay(e,"flex")});return 0===e&&this.setCredentialsInSettings(),POPUP_STATE.add(e),SCREEN_STATE=e,e},Config.prototype.getPopupScreen=function(){return this.credentialed?this._isContrastPage()&&this.credentialed?0:!this._isContrastPage()&&this.hasApp?2:!this._isContrastPage()&&this.credentialed?3:(console.error("Rogue Popup Screen"),1):1},Config.prototype.setCredentialsInSettings=function(){const e=document.getElementById("contrast-url-input"),t=document.getElementById("contrast-service-key-input"),n=document.getElementById("contrast-username-input"),i=document.getElementById("contrast-api-key-input"),o=document.getElementById("contrast-org-uuid-input"),r=this.credentials[TEAMSERVER_URL],s=this.credentials[CONTRAST_SERVICE_KEY],a=this.credentials[CONTRAST_API_KEY],l=this.credentials[CONTRAST_USERNAME],c=this.credentials[CONTRAST_ORG_UUID];e.value=r,t.value=s,n.value=l,i.value=a,o.value=c},Config.prototype.addListenerToConfigButton=function(){document.getElementById("configure-extension-button").addEventListener("click",this._handleConfigButtonClick,!1)},Config.prototype._handleConfigButtonClick=function(e){e.target.setAttribute("disabled",!0),chrome.storage.local.remove([STORED_APPS_KEY,STORED_TRACES_KEY],()=>{if(chrome.runtime.lastError)throw new Error("Error removing stored apps and stored traces")});const t=document.getElementsByClassName("user-inputs");let n=[];for(let e=0,i=t.length;e<i;e++)t[e].value&&t[e].value.length>0&&n.push(!0),n.push(!1);this._isTeamserverAccountPage()&&n.every(e=>!1===e)?this._configureUserByScrapingContrast():this._storeCustomUserConfiguration()},Config.prototype._storeCustomUserConfiguration=function(){const e=document.getElementById("contrast-service-key-input"),t=document.getElementById("contrast-username-input"),n=document.getElementById("contrast-api-key-input"),i=document.getElementById("contrast-org-uuid-input");let o;this._isContrastPage()?(o=this._getOrgUUIDFromURL(),i.value=o):o=i.value;const r=document.getElementById("contrast-url-input");let s;this._isContrastPage()?(s=this._getContrastURL(),r.value=s):s=this._buildContrastUrl(r.value);try{if(!n.value||0===n.value.length)throw new Error("API Key cannot be blank.");if(!e.value||0===e.value.length)throw new Error("Service Key cannot be blank.");if(!t.value||0===t.value.length)throw new Error("Username cannot be blank.");if(!s||0===s.length)throw new Error("Contrast URL cannot be blank.");if(!o||0===o.length)throw new Error("Organization UUID cannot be blank.")}catch(e){return this.renderFailureMessage(e)}const a=new ContrastCredentials({apiKey:n.value,orgUuid:o,teamServerUrl:s,serviceKey:e.value,profileEmail:t.value});try{return this._storeContrastCredentials(a),!0}catch(e){return this.renderFailureMessage(e),!1}},Config.prototype._getContrastURL=function(e){if(e&&e.value&&e.value.length>0)return this._buildContrastUrl(e.value);if(this._isContrastPage()){return new URL(this.url).origin+"/Contrast/api"}return""},Config.prototype._buildContrastUrl=function(e){return 1===e.split("http://").length&&1===e.split("https://").length&&(e=e.includes("localhost")?"http://"+e:"https://"+e),e=(e=new URL(e)).origin+"/Contrast/api"},Config.prototype.renderFailureMessage=function(e,t){const n=document.getElementById("configure-extension-button"),i=document.getElementById("config-failure"),o=document.getElementById("config-failure-message");e&&setElementText(o,e.toString()),changeElementVisibility(i),setElementDisplay(n,"none"),hideElementAfterTimeout(i,()=>{n.removeAttribute("disabled"),setElementDisplay(n,"block")},t)},Config.prototype.renderSuccessMessage=function(e,t=(()=>null),n){const i=document.getElementById("configure-extension-button"),o=document.getElementById("config-success"),r=document.getElementById("config-footer-text");changeElementVisibility(o),setElementDisplay(i,"none"),r.innerText="",r.innerHTML=loadingIconHTML(),this._updateCredentials(e),hideElementAfterTimeout(o,()=>(i.removeAttribute("disabled"),setElementDisplay(i,"block"),r.innerHTML="",i.removeEventListener("click",this._handleConfigButtonClick),t()),n)},Config.prototype._storeContrastCredentials=function(e){chrome.storage.local.set(e,()=>{if(chrome.runtime.lastError)throw new Error("Error setting configuration");this.renderSuccessMessage(e,indexFunction)})},Config.prototype._getOrgUUIDFromURL=function(){const e=new URL(this.url).hash.split("/")[1];return UUID_V4_REGEX.test(e)?e:null},Config.prototype._configureUserByScrapingContrast=function(){chrome.tabs.sendMessage(this.tab.id,{url:this.tab.url,action:CONTRAST_INITIALIZE},e=>{if(e&&e.action)if(e.action===CONTRAST_INITIALIZED)if(e.success){chrome.browserAction.setBadgeText({tabId:this.tab.id,text:""}),this.renderSuccessMessage(e.contrastObj,indexFunction),this.setCredentialsInSettings();const t=document.getElementById("configuration-section");t.display="none",hideElementAfterTimeout(t)}else this.renderFailureMessage(e.message);else this.renderFailureMessage();else this.renderFailureMessage()})},Config.prototype._updateCredentials=function(e){this.credentials=e,this.credentialed=!0},Config.prototype._isTeamserverAccountPage=function(){if(!this.tab||!this.url)throw new Error("_isTeamserverAccountPage expects tab or url");return[this.tab.url.startsWith("http"),VALID_TEAMSERVER_HOSTNAMES.includes(this.url.hostname),this.tab.url.endsWith(TEAMSERVER_ACCOUNT_PATH_SUFFIX)||this.tab.url.endsWith(TEAMSERVER_PROFILE_PATH_SUFFIX),-1!==this.tab.url.indexOf(TEAMSERVER_INDEX_PATH_SUFFIX)].every(e=>!!e)},Config.prototype._isContrastPage=function(){if(!this.tab||!this.url)throw new Error("_isContrastPage expects tab or url");return[this.tab.url.startsWith("http"),VALID_TEAMSERVER_HOSTNAMES.includes(this.url.hostname),this.tab.url.includes("/Contrast/static/ng")].every(e=>!!e)},Config.prototype.renderContrastUsername=function(){const e=document.getElementById("user-email");setElementText(e,this.credentials[CONTRAST_USERNAME]),e.addEventListener("click",this._addListenerToUsername,!1)},Config.prototype._addListenerToUsername=function(){const e=this.credentials[TEAMSERVER_URL].indexOf("/api"),t=this.credentials[TEAMSERVER_URL].substring(0,e);chrome.tabs.create({url:t})},Config.prototype.setGearIcon=function(){document.getElementById("configure-gear").addEventListener("click",this._handleGearClick,!1),document.getElementById("app-icon-container").addEventListener("click",this._handleAppsClick,!1)},Config.prototype._handleGearClick=function(){const e=document.getElementById("gear-container");e.classList.add("configure-gear-rotate"),setTimeout(()=>{e.classList.remove("configure-gear-rotate")},1e3),0!==SCREEN_STATE?(this.popupScreen(0),this.hasApp&&this._setBackButton(!0)):0===SCREEN_STATE&&POPUP_STATE.has(2)?(this.popupScreen(2),this._setBackButton(!1)):(this.popupScreen(0),this.hasApp&&this._setBackButton(!0))},Config.prototype._handleAppsClick=function(){3!==SCREEN_STATE?(this.popupScreen(3),this.hasApp&&this._setBackButton(!0)):3===SCREEN_STATE&&POPUP_STATE.has(2)?(this.popupScreen(2),this._setBackButton(!1)):(this.popupScreen(3),this.hasApp&&this._setBackButton(!0))},Config.prototype._setBackButton=function(e){const t=document.getElementById("user-email");t.removeEventListener("click",this._addListenerToUsername),t.removeEventListener("click",this._handleBackButtonClick),e?(setElementText(t,"Back"),t.addEventListener("click",this._handleBackButtonClick)):(setElementText(t,this.credentials[CONTRAST_USERNAME]),this.renderContrastUsername())},Config.prototype._handleBackButtonClick=function(){this.popupScreen(2),this._setBackButton(!1)};