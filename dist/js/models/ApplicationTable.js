import{STORED_APPS_KEY,setElementText,setElementDisplay,changeElementVisibility,getOrgApplications,getHostFromUrl,isContrastTeamserver,hideElementAfterTimeout}from"../util.js";import Application from"./Application.js";import TableRow from"./PopupTableRow.js";export default function ApplicationTable(e){this.table=document.getElementById("application-table"),this.tableContainer=this.table.parentElement,this.url=e}function _appIsConfigured(e,t){return e[STORED_APPS_KEY]&&e[STORED_APPS_KEY].filter(e=>e[t])[0]}function renderFailureMessage(e,t){const n=document.getElementById("configure-extension-button"),o=document.getElementById("config-failure"),i=document.getElementById("config-failure-message");e&&setElementText(i,e.toString()),changeElementVisibility(o),setElementDisplay(n,"none"),hideElementAfterTimeout(o,()=>{n.removeAttribute("disabled"),setElementDisplay(n,"block")},t)}ApplicationTable.prototype.renderApplicationsMenu=async function(){if(document.getElementsByTagName("tr").length<2){const e=await getOrgApplications();if(!e||e instanceof Error)return void renderFailureMessage("Error Getting Applications. Make sure your credentials are correct.");const t=await this._getStoredApplications(),n=this._filterApplications(t,e.applications);t&&n.forEach(e=>this.createAppTableRow(e,t))}},ApplicationTable.prototype.renderActivityFeed=async function(){this.tableContainer.classList.remove("collapsed");const e=await this._getStoredApplications();if(e){if(_appIsConfigured(e,getHostFromUrl(this.url))){const e=document.getElementById("application-table-container-section");setElementDisplay(e,"none")}else this._showContrastApplications(e)}},ApplicationTable.prototype._getStoredApplications=function(){return new Promise(e=>{chrome.storage.local.get(STORED_APPS_KEY,t=>chrome.runtime.lastError?e(null):e(t))})},ApplicationTable.prototype._showContrastApplications=function(e){const t=document.getElementById("vulnerabilities-section");setElementDisplay(t,"none");const n=document.getElementById("vulns-header-text"),o=n.parentElement.parentElement;setElementText(n,"Connect Applications"),n.style.fontSize="4.5vw",o.style.border="none",document.getElementById("configured-footer").style.border="none",getOrgApplications().then(t=>{if(!t||t instanceof Error)return void renderFailureMessage("Error Getting Applications. Make sure your credentials are correct.",5e3);const n=this._filterApplications(e,t.applications);this.createTableRows(n,e)}).catch(()=>{renderFailureMessage("Error Getting Applications. Make sure your credentials are correct.",5e3)})},ApplicationTable.prototype.createTableRows=function(e,t){e.forEach(e=>this.createAppTableRow(e,t))},ApplicationTable.prototype._filterApplications=function(e,t){if(e[STORED_APPS_KEY]&&!isContrastTeamserver(this.url.href)){const n=e[STORED_APPS_KEY].map(e=>e.id).flatten();return t.map(e=>(e.connectedAlready=n.includes(e.app_id),e))}return t},ApplicationTable.prototype.createAppTableRow=function(e,t){if(!e||!e.name)return;const n=new TableRow(e,this.url,this.table.tBodies[0]);if(n.appendChildren(),isContrastTeamserver(this.url.href))if(t){const o=Application.getStoredApp(t,e);setElementText(n.nameTD,e.name),o&&(n.setHost(o.host),n.renderDisconnect(t,o))}else chrome.storage.local.get(STORED_APPS_KEY,t=>{if(chrome.runtime.lastError)return;t&&t[STORED_APPS_KEY]||(t={[STORED_APPS_KEY]:[]});const o=Application.getStoredApp(t,e);setElementText(n.nameTD,e.name),o&&(n.setHost(o.host),n.renderDisconnect(t,o))});else if(e.connectedAlready){const o=Application.getStoredApp(t,e);setElementText(n.nameTD,e.name),n.setHost(o.host),n.renderDisconnect(t,o)}else n.setHost(getHostFromUrl(this.url)),n.createConnectButton()};