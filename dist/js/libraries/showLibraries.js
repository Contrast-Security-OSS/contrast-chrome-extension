import{SEVERITY,SEVERITY_LOW,SEVERITY_MEDIUM,SEVERITY_HIGH,CONTRAST__STORED_APP_LIBS,SEVERITY_BACKGROUND_COLORS,SEVERITY_TEXT_COLORS,isEmptyObject,capitalize}from"../util.js";import Application from"../models/Application.js";const getLibrariesFromStorage=(e,t)=>new Promise((e,i)=>{const a="APP_LIBS__ID_"+t.domain;chrome.storage.local.get(CONTRAST__STORED_APP_LIBS,t=>{if(isEmptyObject(t))e(null);else{const i=t[CONTRAST__STORED_APP_LIBS][a];e(i)}i(new Error("result was",typeof t))})}),_getTabAndApplication=()=>new Promise((e,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},async i=>{const a=i[0];if(!a)return void t(new Error("Tab is null"));const l=await Application.retrieveApplicationFromStorage(a);e({tab:a,application:l})})}),renderVulnerableLibraries=async(e,t)=>{if(!e||!t){const i=await _getTabAndApplication();e=i.tab,t=i.application}let i=await getLibrariesFromStorage(0,t);if(!i||0===i.length)return;const a=document.getElementById("libs-vulnerabilities-found-on-page"),l=document.getElementById("libs-vulnerabilities-found-on-page-list");let r=[];for(let e=0,t=(i=i.sort((e,t)=>!e.severity&&t.severity?1:e.severity&&!t.severity?-1:e.severity||t.severity?SEVERITY[t.severity.titleize()]-SEVERITY[e.severity.titleize()]:0)).length;e<t;e++){let t=i[e];if(t)for(let e=0;e<t.vulnerabilitiesCount;e++){if(!t.vulnerabilities)continue;let i=t.vulnerabilities[e];i.title=_vulnObjTitle(i);let a=i.name||t.name;r.includes(i.title+a)||(_createVulnerabilityListItem(l,t.name,i),r.push(i.title+a))}}a.classList.remove("hidden"),a.classList.add("visible")},_vulnObjTitle=e=>{let t=e.title;return t||("string"!=typeof(t=e.identifiers)?t.summary:t)},createBadge=(e,t)=>{let i=document.createElement("div");i.classList.add("parent-badge");let a=document.createElement("div");a.classList.add("child-badge"),a.innerText=e,a.style.color=SEVERITY_TEXT_COLORS[e],i.style.backgroundColor=SEVERITY_BACKGROUND_COLORS[e],i.appendChild(a),t.appendChild(i)},_createVulnerabilityListItem=(e,t,i)=>{let{name:a,severity:l,title:r,link:n}=i;a||(a=(a=t).titleize());let s=document.createElement("li");switch(s.classList.add("list-group-item"),s.classList.add("no-border"),s.classList.add("vulnerability-li"),l.toLowerCase()){case SEVERITY_LOW.toLowerCase():createBadge(SEVERITY_LOW,s);break;case SEVERITY_MEDIUM.toLowerCase():createBadge(SEVERITY_MEDIUM,s);break;case SEVERITY_HIGH.toLowerCase():createBadge(SEVERITY_HIGH,s)}a=a.replace("Jquery","JQuery");let o=document.createElement("a");o.classList.add("vulnerability-link"),o.classList.add("vulnerability-rule-name"),o.innerText=a+":  "+capitalize(r.trim()),o.onclick=function(){chrome.tabs.create({url:n,active:!1})},s.appendChild(o),e.appendChild(s)};export{renderVulnerableLibraries};