"use strict";function _scrapeServiceKey(){const e=document.querySelector('[key-status-rotated="userKeyStatus.rotated"]');return e?e.innerText:null}function _scrapeApiKey(){const e=document.querySelector("span.break-word.org-key.ng-binding");return e?e.innerText:null}function _scrapeOrgUUID(){const e=document.location.hash.split("/")[1];return UUID_V4_REGEX.test(e)?e:null}function _scrapeProfileEmail(){const e=document.querySelector(".profile-email");return e?e.innerText:null}function _initializeContrast(e,t){const r=e.url.indexOf(TEAMSERVER_INDEX_PATH_SUFFIX),n=e.url.substring(0,r)+TEAMSERVER_API_PATH_SUFFIX,i=_scrapeApiKey(),a=_scrapeServiceKey(),s=_scrapeOrgUUID(),o=_scrapeProfileEmail(),l={[CONTRAST_USERNAME]:o,[CONTRAST_SERVICE_KEY]:a,[CONTRAST_API_KEY]:i,[CONTRAST_ORG_UUID]:s,[TEAMSERVER_URL]:n};Object.values(l).forEach(e=>{e||t({action:CONTRAST_INITIALIZED,success:!1,message:"Failed to configure extension. Try configuring the extension manually."})}),chrome.storage.local.set(l,()=>{if(chrome.runtime.lastError)throw new Error("Error setting configuration");t({action:CONTRAST_INITIALIZED,success:!0,contrastObj:l})})}function _getLibraryVulnerabilities(){return fetch("https://raw.githubusercontent.com/RetireJS/retire.js/master/repository/jsrepository.json",{method:"GET"}).then(e=>e.ok&&200===e.status?e.json():null).catch(new Error("Error getting js lib vulnerabilities"))}async function _collectScripts(e){const t=await _getLibraryVulnerabilities();if(!t)return null;const r=await wappalzye(e),n=_compareAppAndVulnerableLibraries([].slice.call(document.scripts).map(e=>{let t=e.src.split("/");return t[t.length-1]}),r,t);return n&&0!==n.length?{sharedLibraries:n}:null}function _compareAppAndVulnerableLibraries(e,t,r){return t=t.map(e=>{let t=e.name.toLowerCase();return e.jsFileName=t,e.parsedLibName=t,e.parsedLibNameJS=t+".js",e}),_findCommonLibraries(r,e.map(e=>{if(e&&e[0]&&new RegExp(/[a-z]/).test(e[0])){let t=e,r=_getLibNameFromJSFile(e);return{jsFileName:t,parsedLibName:r,parsedLibNameJS:r+".js"}}return!1}).filter(Boolean),t)}function _findCommonLibraries(e,t,r){let n=[];for(let i in e)if(Object.prototype.hasOwnProperty.call(e,i)){let a=e[i],s=[];if(s.push(i),a.bowername){let e=a.bowername.map(e=>e.toLowerCase());s=s.concat(e)}let o=r.filter(e=>(e.name=e.name.toLowerCase(),s.includes(e.parsedLibName)||s.includes(e.parsedLibNameJS))),l=t.filter(e=>s.includes(e.jsFileName)||s.includes(e.parsedLibName)||s.includes(e.parsedLibNameJS)),c=o.concat(l);if(c[0]){if(!n.find(e=>c[0].parsedLibName===e.parsedLibName)){const e=c[0],t=a.extractors;e.name=i,e.extractors=t,e.vulnerabilities=a.vulnerabilities,n.push(e)}}}return n}function _getLibNameFromJSFile(e){return e=(e=(e=(e=(e=e.split(".js")[0]).split(".min")[0]).split("-min")[0]).split("_min")[0]).match(/([a-zA-Z]+\W)+/)?e.match(/([a-zA-Z]+\W)+/)[0]:e,e=new RegExp(/\W/).test(e[e.length-1])?e.substr(0,e.length-1):e}function wappalzye(e){return new Promise(t=>{chrome.runtime.sendMessage({action:CONTRAST_WAPPALIZE,tab:e},e=>{t(e)})})}1===window.performance.navigation.type?window.CONTRAST__REFRESHED=!0:window.CONTRAST__REFRESHED=!1,window.addEventListener("load",function(){chrome.runtime.sendMessage({action:LOADING_DONE}),setTimeout(function(){window.CONTRAST__REFRESHED=!1},1e3)}),chrome.runtime.onMessage.addListener((e,t,r)=>{if(e.action===GATHER_FORMS_ACTION)document.getElementsByTagName("form").length>0?setTimeout(()=>ContrastForm.collectFormActions(r),1e3):ContrastForm.collectFormActions(r);else if(e.action===HIGHLIGHT_VULNERABLE_FORMS)r(ContrastForm.highlightForms(e.formActions));else if(void 0!==e.url&&e.action===CONTRAST_INITIALIZE)_initializeContrast(e,r);else if("GET_LIB_VERSION"===e.action&&e.library){const t=e.library.parsedLibName.replace("-","_"),n=document.getElementById(`__script_res_${t}`);let i;try{i=n.innerText}catch(e){r(null)}if(i){let e=i.split("_");r(e[e.length-1])}else r(null)}else e.action===GATHER_SCRIPTS&&_collectScripts(e.tab).then(e=>r(e)).catch(e=>{});return!0});