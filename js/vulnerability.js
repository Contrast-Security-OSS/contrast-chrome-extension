/*global
chrome,
document,
*/

import { getStorageVulnsAndRender } from './vulnerabilityMethods.js';
import {
  STORED_APPS_KEY,
  getStoredCredentials,
  isCredentialed,
  getHostFromUrl,
} from './util.js'

document.addEventListener('DOMContentLoaded', () => {
  console.log("loaded");
  chrome.storage.local.get(STORED_APPS_KEY, (result) => {
    console.log("stored apps result");
    chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
      console.log("chrome tabs", tabs);
      if (!tabs[0]) return;

      const url  = new URL(tabs[0].url);
      const host = getHostFromUrl(url);

      if (!!result[STORED_APPS_KEY] && result[STORED_APPS_KEY].filter(app => app[host])[0]) {
        getStoredCredentials()
        .then(items => {
          console.log("credentials");
          if (isCredentialed(items)) {
            console.log("get storage vulns");
            getStorageVulnsAndRender(items);
          } else {
            throw new Error("Not Credentialed")
          }
        })
        .catch(error => new Error(error));
      }
    });
  });
}, false);
