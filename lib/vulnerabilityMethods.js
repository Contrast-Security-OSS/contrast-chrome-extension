"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getShortVulnerabilities = exports.getStorageVulnsAndRender = exports.renderListItem = exports.populateVulnerabilitySection = undefined;

var _helpersModule = require("./helpers/helpers-module.js");

var CONTRAST_ORG_UUID = _helpersModule.Helpers.CONTRAST_ORG_UUID,
    TEAMSERVER_URL = _helpersModule.Helpers.TEAMSERVER_URL,
    SEVERITY_NOTE = _helpersModule.Helpers.SEVERITY_NOTE,
    SEVERITY_LOW = _helpersModule.Helpers.SEVERITY_LOW,
    SEVERITY_MEDIUM = _helpersModule.Helpers.SEVERITY_MEDIUM,
    SEVERITY_HIGH = _helpersModule.Helpers.SEVERITY_HIGH,
    SEVERITY_CRITICAL = _helpersModule.Helpers.SEVERITY_CRITICAL,
    SEVERITY = _helpersModule.Helpers.SEVERITY,
    SEVERITY_NOTE_ICON_PATH = _helpersModule.Helpers.SEVERITY_NOTE_ICON_PATH,
    SEVERITY_LOW_ICON_PATH = _helpersModule.Helpers.SEVERITY_LOW_ICON_PATH,
    SEVERITY_MEDIUM_ICON_PATH = _helpersModule.Helpers.SEVERITY_MEDIUM_ICON_PATH,
    SEVERITY_HIGH_ICON_PATH = _helpersModule.Helpers.SEVERITY_HIGH_ICON_PATH,
    SEVERITY_CRITICAL_ICON_PATH = _helpersModule.Helpers.SEVERITY_CRITICAL_ICON_PATH,
    TRACES_REQUEST = _helpersModule.Helpers.TRACES_REQUEST,
    getVulnerabilityTeamserverUrl = _helpersModule.Helpers.getVulnerabilityTeamserverUrl,
    setElementDisplay = _helpersModule.Helpers.setElementDisplay,
    getVulnerabilityShort = _helpersModule.Helpers.getVulnerabilityShort;

/**
 * populateVulnerabilitySection - Get details about each trace from teamserver and then render each of them as a list item in the extension popup
 *
 * @param  {Array<String>} traces Trace uuids sent to teamserver for more info
 * @param  {String} teamserverUrl The url of the TS environment we're using
 * @param  {String} orgUuid       The uuid of our org
 * @return {void}                 Renders a list of vulnerabilities
 */
/*global
	chrome,
	Helpers,
*/

function populateVulnerabilitySection(traces, teamserverUrl, orgUuid) {
  if (traces.length > 0) {
    getShortVulnerabilities(traces).then(function (sortedTraces) {
      sortedTraces.map(function (trace) {
        return renderListItem(trace, teamserverUrl, orgUuid);
      });
    }).catch(new Error("Error rendering sorted traces into list items."));
  } else {
    var noVulnsFound = document.getElementById("no-vulnerabilities-found");
    var vulnsOnPage = document.getElementById("vulnerabilities-found-on-page");
    setElementDisplay(noVulnsFound, "block");
    setElementDisplay(vulnsOnPage, "none");
  }
}

function getShortVulnerabilities(traces) {
  return Promise.all(traces.map(function (t) {
    return getVulnerabilityShort(t);
  })).then(function (shortTraces) {
    return shortTraces.sort(function (a, b) {
      var severityA = a.trace.severity;
      var severityB = b.trace.severity;
      return SEVERITY[severityA] < SEVERITY[severityB];
    });
  }).catch(new Error("Error getting and rendering vulnerabilities"));
}

/**
 * renderListItem - Renders details about a vulnerability as a list item
 *
 * @param  {Object} shortTrace    Details about a vulnerability
 * @param  {String} teamserverUrl The url of the TS environment we're using
 * @param  {String} orgUuid       The uuid of our org
 * @return {void}                 a new list item
 */
function renderListItem(shortTrace, teamserverUrl, orgUuid) {
  var trace = shortTrace.trace;

  if (!trace) return;

  var ul = document.getElementById('vulnerabilities-found-on-page-list');
  var li = document.createElement('li');
  li.classList.add('list-group-item');
  li.classList.add('no-border');
  li.classList.add('vulnerability-li');

  var img = document.createElement('img');

  switch (trace.severity) {
    case SEVERITY_NOTE:
      img.setAttribute("src", SEVERITY_NOTE_ICON_PATH);
      li.classList.add("vuln-5");
      break;
    case SEVERITY_LOW:
      img.setAttribute("src", SEVERITY_LOW_ICON_PATH);
      li.classList.add("vuln-4");
      break;
    case SEVERITY_MEDIUM:
      img.setAttribute("src", SEVERITY_MEDIUM_ICON_PATH);
      li.classList.add("vuln-3");
      break;
    case SEVERITY_HIGH:
      img.setAttribute("src", SEVERITY_HIGH_ICON_PATH);
      li.classList.add("vuln-2");
      break;
    case SEVERITY_CRITICAL:
      img.setAttribute("src", SEVERITY_CRITICAL_ICON_PATH);
      li.classList.add("vuln-1");
      break;
    default:
      break;
  }
  li.appendChild(img);

  // Teamserver returns camelCase vs snake_case depending on endpoint
  var ruleName = trace.ruleName || trace.rule_name;

  var anchor = document.createElement('a');
  // anchor.setAttribute('href', '');
  anchor.classList.add('vulnerability-rule-name');
  anchor.innerText = " " + ruleName.split('-').join(' ').titleize();
  anchor.onclick = function () {
    chrome.tabs.create({
      url: getVulnerabilityTeamserverUrl(teamserverUrl, orgUuid, trace.uuid),
      active: false
    });
  };
  li.appendChild(anchor);

  // append li last to load content smootly (is the way it works?)
  ul.appendChild(li);
}

/**
 * getStorageVulnsAndRender - gets stored traces from background, renders the vulnerability section of the popup and sends the vulnerabilities to populateVulnerabilitySection for rendering into a list
 *
 * @param  {Object} items - credentials
 * @return {void}
 */
function getStorageVulnsAndRender(items) {
  var noVulnsFound = document.getElementById("no-vulnerabilities-found");
  var vulnsOnPage = document.getElementById("vulnerabilities-found-on-page");

  chrome.runtime.sendMessage(TRACES_REQUEST, function (response) {
    if (!!response && !!response.traces && response.traces.length > 0) {
      setElementDisplay(noVulnsFound, "none");
      setElementDisplay(vulnsOnPage, "block");

      populateVulnerabilitySection(response.traces, items[TEAMSERVER_URL], items[CONTRAST_ORG_UUID]);
    } else {
      setElementDisplay(noVulnsFound, "block");
      setElementDisplay(vulnsOnPage, "none");
      throw new Error("Couldn't send request for stored traces");
    }
  });
}

exports.populateVulnerabilitySection = populateVulnerabilitySection;
exports.renderListItem = renderListItem;
exports.getStorageVulnsAndRender = getStorageVulnsAndRender;
exports.getShortVulnerabilities = getShortVulnerabilities;