'use strict';

var _vulnerabilityMethods = require('./vulnerabilityMethods.js');

var _util = require('./util.js');

/*global
chrome,
document,
*/

document.addEventListener('DOMContentLoaded', function () {
  chrome.storage.local.get(_util.STORED_APPS_KEY, function (result) {
    chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {
      if (!tabs[0]) return;

      var url = new URL(tabs[0].url);
      var host = (0, _util.getHostFromUrl)(url);

      if (!!result[_util.STORED_APPS_KEY] && result[_util.STORED_APPS_KEY].filter(function (app) {
        return app[host];
      })[0]) {
        (0, _util.getStoredCredentials)().then(function (items) {
          if ((0, _util.isCredentialed)(items)) {
            (0, _vulnerabilityMethods.getStorageVulnsAndRender)(items);
          } else {
            throw new Error("Not Credentialed");
          }
        }).catch(function (error) {
          return new Error(error);
        });
      }
    });
  });
}, false);