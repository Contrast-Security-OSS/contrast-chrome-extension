'use strict';

var _vulnerabilityMethods = require('./vulnerabilityMethods.js');

var _Helpers = Helpers,
    STORED_APPS_KEY = _Helpers.STORED_APPS_KEY,
    CONTRAST__STORED_APP_LIBS = _Helpers.CONTRAST__STORED_APP_LIBS,
    getStoredCredentials = _Helpers.getStoredCredentials,
    isCredentialed = _Helpers.isCredentialed,
    getHostFromUrl = _Helpers.getHostFromUrl; /*global
                                              chrome,
                                              document,
                                              Helpers,
                                              */

document.addEventListener('DOMContentLoaded', function () {
  chrome.storage.local.get([STORED_APPS_KEY, CONTRAST__STORED_APP_LIBS], function (result) {
    chrome.tabs.query({ active: true, lastFocusedWindow: true }, function (tabs) {
      if (!tabs[0]) return;

      var url = new URL(tabs[0].url);
      var host = getHostFromUrl(url);

      if (!!result[STORED_APPS_KEY] && result[STORED_APPS_KEY].filter(function (app) {
        return app[host];
      })[0]) {
        getStoredCredentials().then(function (items) {
          if (isCredentialed(items)) {
            (0, _vulnerabilityMethods.getStorageVulnsAndRender)(items);
          } else {
            throw new Error("Not Credentialed");
          }
        }).catch(function (error) {
          return new Error(error);
        });
      }
    });
  });
}, false);